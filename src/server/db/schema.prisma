datasource db {
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  provider          = "mysql"
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["typedSql"]
}

model User {
  id                        Int         @id @default(autoincrement())
  username                  String      @db.VarChar(128) @unique
  email                     String      @unique @db.VarChar(255)
  passwordHash              String?     @db.Char(110)
  authType                  String      @default("local") @db.VarChar(50)
  role                      String      @default("user") @db.VarChar(50)
  status                    String      @default("active") @db.VarChar(50)
  avatarUrl                 String?     @db.VarChar(255)
  emailVerified             Boolean     @default(false)
  emailVerificationToken    String?     @db.Char(36)
  passwordResetToken        String?     @db.Char(36)
  passwordResetTokenExpires DateTime?   @db.DateTime
  createdAt                 DateTime    @default(now()) @db.DateTime(3)
  updatedAt                 DateTime    @updatedAt @db.DateTime(3)
  lastLogin                 DateTime?   @db.DateTime(3)
  lastPasswordReset         DateTime?   @db.DateTime(3)

  // Relations
  recipes                   Recipe[]    @relation("AuthoredRecipes")
  visitedRecipes            UserVisitedRecipe[]
  ratings                   Rating[]
  shoppingList              ShoppingListIngredient[]
  flags                     RecipeFlag[]

  // Indexes
  @@index([username])
  @@index([email])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])

  @@map("users")  
}
 
model Recipe {
  id           Int       @id @default(autoincrement())
  displayId    String    @unique @db.Char(36)
  authorId     Int       @db.Int
  language     String    @db.VarChar(2)
  title        String    @db.VarChar(255)
  notes        String?   @db.Text
  time         Int?      @db.Int
  portionSize  Int?      @db.Int
  imageUrl     String?   @db.VarChar(255)
  rating       Decimal?  @db.Decimal(2, 1)
  timesRated   Int       @default(0)
  timesViewed  Int       @default(0)
  createdAt    DateTime  @default(now()) @db.DateTime(3)
  updatedAt    DateTime  @updatedAt @db.DateTime(3)

  // Relations
  author       User                @relation("AuthoredRecipes", fields: [authorId], references: [id])
  instructions Instruction[]
  ingredients  RecipeIngredient[]
  ratings      Rating[]
  shoppingList ShoppingListIngredient[]
  visitedBy    UserVisitedRecipe[]
  tags         RecipeTag[]
  flags        RecipeFlag[]
  
  // Indexes
  @@index([authorId])
  @@index([displayId])
  @@index([language])
  @@index([title])
  @@index([rating])
  @@index([time])
  @@index([createdAt])
  @@index([rating, time], name: "idx_recipes_rating_time")
  @@map("recipes")
}

model Instruction {
  recipeId Int    @db.Int
  step     Int    @db.Int
  text     String @db.Text

  // Relations
  recipe   Recipe @relation(fields: [recipeId], references: [id])

  // Composite primary key
  @@id([recipeId, step])
  @@index([recipeId])
  @@index([step])
  @@map("instructions")
}

model Ingredient {
  id       Int    @id @default(autoincrement()) @db.Int
  language String @db.VarChar(2)
  name     String @db.VarChar(50)

  // Relations
  recipes  RecipeIngredient[]
  shoppingLists ShoppingListIngredient[]

  // Unique constraint
  @@unique([language, name], name: "unique_ingredient_language_name")

  // Indexes
  @@index([language])
  @@index([name])
  @@map("ingredients")
}

model RecipeIngredient {
  recipeId        Int     @db.Int
  ingredientId    Int     @db.Int
  quantity        String? @db.VarChar(256)
  ingredientOrder Int     @db.Int

  // Relations
  recipe     Recipe     @relation(fields: [recipeId], references: [id])
  ingredient Ingredient @relation(fields: [ingredientId], references: [id])


  // Composite primary key
  @@id([recipeId, ingredientId])
  @@index([recipeId])
  @@index([ingredientId])
  @@map("recipes_ingredients")
}

model ShoppingListIngredient {
  userId          Int     @db.Int
  recipeId        Int     @db.Int
  ingredientId    Int     @db.Int
  quantity        String? @db.VarChar(256)
  marked          Boolean @default(false)
  ingredientOrder Int     @db.Int

  // Relations
  user       User       @relation(fields: [userId], references: [id])
  recipe     Recipe     @relation(fields: [recipeId], references: [id])
  ingredient Ingredient @relation(fields: [ingredientId], references: [id])

  // Composite primary key
  @@id([userId, ingredientId, recipeId])
  @@index([userId, recipeId])
  @@index([userId])
  @@index([ingredientId])
  @@map("shopping_list_ingredients")
}

model Rating {
  id        Int      @id @default(autoincrement()) @db.Int
  recipeId  Int      @db.Int
  userId    Int      @db.Int
  rating    Decimal  @db.Decimal(2, 1)
  createdAt DateTime @default(now()) @db.DateTime(3)
  updatedAt DateTime @updatedAt @db.DateTime(3)

  // Relations
  recipe Recipe @relation(fields: [recipeId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  // Unique constraint
  @@unique([recipeId, userId], name: "unique_recipe_user")
  @@index([recipeId])
  @@index([userId])
  @@map("ratings")
}

model UserVisitedRecipe {
  userId    Int      @db.Int
  recipeId  Int      @db.Int
  visitedAt DateTime @default(now()) @db.DateTime(3)

  // Relations
  user   User   @relation(fields: [userId], references: [id])
  recipe Recipe @relation(fields: [recipeId], references: [id])

  // Unique constraint to prevent duplicate visits (can be updated with new timestamp)
  @@unique([userId, recipeId], name: "unique_user_recipe_visit")
  @@index([userId, visitedAt])
  @@index([userId])
  @@index([recipeId])
  @@map("user_visited_recipes")
}

model RecipeFlag {
  id         Int       @id @default(autoincrement()) @db.Int
  userId     Int       @db.Int
  recipeId   Int       @db.Int
  reason     String    @db.VarChar(255)
  resolved   Boolean   @default(false)
  active     Boolean   @default(true)
  resolvedAt DateTime? @db.DateTime(3)
  createdAt  DateTime  @default(now()) @db.DateTime(3)

  // Relations
  user   User   @relation(fields: [userId], references: [id])
  recipe Recipe @relation(fields: [recipeId], references: [id])

  // Indexes
  @@index([userId])
  @@index([recipeId])

  @@map("recipe_flags")
}

model TagCategory {
  id    Int    @id @default(autoincrement())
  name  String @unique @db.VarChar(50)

  // Relations
  tags  Tag[]

  // Indexes
  @@index([name])
  @@map("tag_categories")
}

model Tag {
  id          Int          @id @default(autoincrement())
  slug        String       @unique @db.VarChar(50)
  categoryId  Int          @db.Int

  // Relations
  category    TagCategory  @relation(fields: [categoryId], references: [id])
  recipes     RecipeTag[]
  translations TagTranslation[]

  // Indexes
  @@index([categoryId])
  @@index([slug])
  @@map("tags")
}

model RecipeTag {
  recipeId Int @db.Int
  tagId    Int @db.Int

  // Relations
  recipe Recipe @relation(fields: [recipeId], references: [id])
  tag    Tag    @relation(fields: [tagId], references: [id])

  // Composite primary key
  @@id([recipeId, tagId])
  @@index([tagId])
  @@map("recipes_tags")
}

model TagTranslation {
  tagId    Int          @db.Int
  language String       @db.VarChar(2)
  name     String       @db.VarChar(50)

  // Relations
  tag      Tag          @relation(fields: [tagId], references: [id])

  // Composite primary key to ensure single translation per language
  @@id([tagId, language])
  @@index([language])
  @@map("tag_translations")
}
