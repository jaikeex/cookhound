datasource db {
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  provider          = "mysql"
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["typedSql"]
}

model User {
  id                        Int         @id @default(autoincrement())
  username                  String      @db.VarChar(128) @unique
  email                     String      @unique @db.VarChar(255)
  passwordHash              String?     @db.Char(110)
  authType                  String      @default("local") @db.VarChar(50)
  role                      String      @default("user") @db.VarChar(50)
  status                    String      @default("active") @db.VarChar(50)
  avatarUrl                 String?     @db.VarChar(255)
  emailVerified             Boolean     @default(false)
  emailVerificationToken    String?     @db.Char(36)
  passwordResetToken        String?     @db.Char(36)
  passwordResetTokenExpires DateTime?   
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt
  lastLogin                 DateTime?   
  lastPasswordReset         DateTime?

  // Relations
  recipes                   Recipe[]
  ratings                   Rating[]
  shoppingList              ShoppingListIngredient[]

  // Indexes
  @@index([username])
  @@index([email])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])

  @@map("users")  
}
 
model Recipe {
  id           Int       @id @default(autoincrement())
  displayId    String    @unique @db.Char(36)
  authorId     Int       @db.Int
  language     String    @db.VarChar(2)
  title        String    @db.VarChar(255)
  notes        String?   @db.Text
  time         Int?
  portionSize  Int?      @db.Int
  imageUrl     String?   @db.VarChar(255)
  rating       Decimal?  @db.Decimal(2, 1)
  timesRated   Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  author       User                @relation(fields: [authorId], references: [id])
  instructions Instruction[]
  ingredients  RecipeIngredient[]
  ratings      Rating[]
  shoppingList ShoppingListIngredient[]
  
  // Indexes
  @@index([authorId])
  @@index([displayId])
  @@index([language])
  @@index([title])
  @@index([rating])
  @@index([time])
  @@index([createdAt])
  @@index([rating, time], name: "idx_recipes_rating_time")
  @@map("recipes")
}

model Instruction {
  recipeId Int    @db.Int
  step     Int
  text     String @db.Text

  // Relations
  recipe   Recipe @relation(fields: [recipeId], references: [id])

  // Composite primary key
  @@id([recipeId, step])
  @@index([recipeId])
  @@index([step])
  @@map("instructions")
}

model Ingredient {
  id       Int    @id @default(autoincrement())
  language String @db.VarChar(2)
  name     String @db.VarChar(50)

  // Relations
  recipes  RecipeIngredient[]
  shoppingLists ShoppingListIngredient[]

  // Unique constraint
  @@unique([language, name], name: "unique_ingredient_language_name")

  // Indexes
  @@index([language])
  @@index([name])
  @@map("ingredients")
}

model Unit {
  id       Int    @id @default(autoincrement())
  language String @db.VarChar(2)
  name     String @db.VarChar(50)

  // Unique constraint
  @@unique([language, name])
  @@index([language])
  @@index([name])
  @@map("units")
}

model RecipeIngredient {
  recipeId        Int     @db.Int
  ingredientId    Int     @db.Int
  quantity        String? @db.VarChar(256)
  ingredientOrder Int     @db.Int

  // Relations
  recipe     Recipe     @relation(fields: [recipeId], references: [id])
  ingredient Ingredient @relation(fields: [ingredientId], references: [id])


  // Composite primary key
  @@id([recipeId, ingredientId])
  @@index([recipeId])
  @@index([ingredientId])
  @@map("recipes_ingredients")
}

model ShoppingListIngredient {
  userId          Int     @db.Int
  recipeId        Int     @db.Int
  ingredientId    Int     @db.Int
  quantity        String? @db.VarChar(256)
  marked          Boolean @default(false)
  ingredientOrder Int     @db.Int

  // Relations
  user       User       @relation(fields: [userId], references: [id])
  recipe     Recipe     @relation(fields: [recipeId], references: [id])
  ingredient Ingredient @relation(fields: [ingredientId], references: [id])

  // Composite primary key
  @@id([userId, ingredientId, recipeId])
  @@index([userId, recipeId])
  @@index([userId])
  @@index([ingredientId])
  @@map("shopping_list_ingredients")
}

model Rating {
  id        Int      @id @default(autoincrement())
  recipeId  Int      @db.Int
  userId    Int      @db.Int
  rating    Decimal  @db.Decimal(2, 1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  recipe Recipe @relation(fields: [recipeId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  // Unique constraint
  @@unique([recipeId, userId], name: "unique_recipe_user")
  @@index([recipeId])
  @@index([userId])
  @@map("ratings")
}
