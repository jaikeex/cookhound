datasource db {
  url               = env("DATABASE_URL")
  provider          = "mysql"
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                        Int         @id @default(autoincrement())
  username                  String      @db.VarChar(128) @unique
  email                     String      @unique @db.VarChar(255)
  passwordHash              String?     @db.Char(110)
  authType                  String      @default("local") @db.VarChar(50)
  role                      String      @default("user") @db.VarChar(50)
  status                    String      @default("active") @db.VarChar(50)
  avatarUrl                 String?     @db.VarChar(255)
  emailVerified             Boolean     @default(false)
  emailVerificationToken    String?     @db.Char(36)
  passwordResetToken        String?     @db.Char(36)
  passwordResetTokenExpires DateTime?   
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt
  lastLogin                 DateTime?   
  lastPasswordReset         DateTime?

  // Relations
  recipes                   Recipe[]
  ratings                   Rating[]

  // Indexes
  @@index([username])
  @@index([email])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])

  @@map("users")  
}
 
model Recipe {
  id           Int       @id @default(autoincrement())
  authorId     Int       @map("author_id")
  language     String    @db.VarChar(2)
  title        String    @db.VarChar(255)
  notes        String?   @db.Text
  time         Int?
  difficulty   String?   @db.VarChar(50)
  portionSize  Int?      @map("portion_size")
  imageUrl     String?   @db.VarChar(255) @map("image_url")
  rating       Decimal?  @db.Decimal(2, 1)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  author       User                @relation(fields: [authorId], references: [id])
  instructions Instruction[]
  ingredients  RecipeIngredient[]
  ratings      Rating[]

  // Indexes
  @@index([authorId])
  @@index([language])
  @@index([title])
  @@index([difficulty])
  @@index([rating])
  @@index([time])
  @@index([createdAt])
  @@index([difficulty, rating, time], name: "idx_recipes_difficulty_rating_time")
  @@index([difficulty, rating], name: "idx_recipes_difficulty_rating")
  @@index([difficulty, time], name: "idx_recipes_difficulty_time")
  @@index([rating, time], name: "idx_recipes_rating_time")
  @@map("recipes")
}

model Instruction {
  recipeId Int    @map("recipe_id")
  step     Int
  text     String @db.Text

  // Relations
  recipe   Recipe @relation(fields: [recipeId], references: [id])

  // Composite primary key
  @@id([recipeId, step])
  @@index([recipeId])
  @@index([step])
  @@map("instructions")
}

model Ingredient {
  id       Int    @id @default(autoincrement())
  language String @db.VarChar(2)
  name     String @unique @db.VarChar(50)

  // Relations
  recipes  RecipeIngredient[]

  // Indexes
  @@index([language])
  @@index([name])
  @@map("ingredients")
}

model Unit {
  id       Int    @id @default(autoincrement())
  language String @db.VarChar(2)
  name     String @db.VarChar(50)

  // Unique constraint
  @@unique([language, name])
  @@index([language])
  @@index([name])
  @@map("units")
}

model RecipeIngredient {
  recipeId        Int    @map("recipe_id")
  ingredientId    Int    @map("ingredient_id")
  quantity        String @db.VarChar(256)
  ingredientOrder Int    @map("ingredient_order")

  // Relations
  recipe     Recipe     @relation(fields: [recipeId], references: [id])
  ingredient Ingredient @relation(fields: [ingredientId], references: [id])

  // Composite primary key
  @@id([recipeId, ingredientId])
  @@index([recipeId])
  @@index([ingredientId])
  @@map("recipes_ingredients")
}

model Rating {
  id        Int      @id @default(autoincrement())
  recipeId  Int      @map("recipe_id")
  userId    Int      @map("user_id")
  rating    Decimal  @db.Decimal(2, 1)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  recipe Recipe @relation(fields: [recipeId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  // Unique constraint
  @@unique([recipeId, userId], name: "unique_recipe_user")
  @@index([recipeId])
  @@index([userId])
  @@map("ratings")
}
